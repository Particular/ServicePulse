<!DOCTYPE html>
<html>
<head>
    <title>SignalR Listener</title>

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css">
    <link type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Inconsolata">
    <link rel="stylesheet" href="http://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        .blue-grey {
            background-color: #607d8b !important;
        }

        .teal {
            background-color: #009688 !important;
        }

        .amber {
            background-color: #ffc107 !important;
        }

        .orange {
            background-color: #ff9800 !important;
        }
    </style>
</head>
<body>


<div class="container">
    <div class="row"><div id="discussion" class="col s12"></div></div>
</div>
<!--Script references. -->
<!--Reference the jQuery library. -->
<script src="/Scripts/jquery-1.11.3.min.js"></script>
<!--Reference the SignalR library. -->
<script src="/Scripts/jquery.signalR-1.2.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->

<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>

<!--Add script to update the page and send messages.-->
<script type="text/javascript">
    $(function() {

        var url = 'http://localhost:33333/api/messagestream';
        // Start the connection.
        var connection = $.connection(url);

        connection.logging = true;

        connection.received(function(data) {
            console.log(data);

            for (var i in data.types) {
                $('#discussion')
                    .append(
                        "<div class='card-panel blue-grey'>" +
                        "<span class='white-text'>" + data.types[i] + "</span>" +
                        "<p class='white-text'>" + JSON.stringify(data.message) + "</p>" +
                        "</div>"
                );
            }
        });

        connection
            .start()
            .done(function() {

                console.log('SignalR started');

                $('#discussion')
                    .append("<div class='card-panel teal'><span class='white-text'>Signalr Started</span></div>");

                connection.error(function(error) {
                    console.log(error);
                    $('#discussion').append("<div class='card-panel orange'><span class='white-text'>" + error + "</span></div>");
                });

                connection.reconnected(function() {
                    console.log('reconnected');
                    $('#discussion').append("<div class='card-panel teal'><div class='card-content'><span class='card-title activator grey-text text-darken-4'>Reconnected!</div></div>");

                });

                connection.stateChanged(function(change) {
                    console.log('SignalR state changed to=' + change.newState);

                    if (change.newState === $.signalR.connectionState.disconnected) {
                        console.log('The server is offline');
                    }
                });

            })
            .fail(function() {
                console.log('Can not connect');
                $('#discussion').append("<div class='card-panel amber'><div class='card-content'><span class='card-title activator grey-text text-darken-4'>Cannot Connect!</div></div>");

            });

    });
</script>
</body>
</html>